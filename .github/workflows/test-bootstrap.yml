name: Test Bootstrap

on:
  push:
    branches: [main]
    paths:
      - 'scripts/bootstrap.sh'
      - '.github/workflows/test-bootstrap.yml'
  pull_request:
    paths:
      - 'scripts/bootstrap.sh'
  workflow_dispatch:

jobs:
  test-bootstrap:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:24.04

    steps:
      - name: Install prerequisites
        run: |
          apt-get update
          apt-get install -y git curl sudo tree xz-utils fontconfig

      - name: Create test user
        run: |
          useradd -m -s /bin/bash clay
          echo "clay ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

      - name: Clone dotfiles
        run: |
          su - clay -c "git clone https://github.com/claydugo/dotfiles.git ~/dotfiles"

      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          path: dotfiles-pr

      - name: Copy PR changes
        run: |
          cp -r dotfiles-pr/* /home/clay/dotfiles/ 2>/dev/null || true
          cp -r dotfiles-pr/.* /home/clay/dotfiles/ 2>/dev/null || true
          chown -R clay:clay /home/clay/dotfiles

      - name: Run bootstrap
        run: |
          su - clay -c "cd ~/dotfiles && ./scripts/bootstrap.sh"

      - name: Verify symlinks
        run: |
          su - clay -c '
            set -e
            echo "Checking symlinks..."
            [ -L ~/.bashrc ] && echo "✓ .bashrc"
            [ -L ~/.gitignore ] && echo "✓ .gitignore"
            [ -L ~/.gitlab_ci_skip ] && echo "✓ .gitlab_ci_skip"
            [ -L ~/.claude ] && echo "✓ .claude"
            [ -L ~/.config/nvim ] && echo "✓ .config/nvim"
            [ -L ~/.config/kitty ] && echo "✓ .config/kitty"
            [ -L ~/.config/starship.toml ] && echo "✓ .config/starship.toml"
          '

      - name: Verify cargo packages
        run: |
          su - clay -c '
            source ~/.cargo/env
            set -e
            echo "Checking cargo packages..."
            command -v jj && echo "✓ jj"
            command -v hyperfine && echo "✓ hyperfine"
            command -v stylua && echo "✓ stylua"
            # gifski skipped - requires compilation from source
          '

      - name: Verify pixi packages
        run: |
          su - clay -c '
            export PATH="$HOME/.pixi/bin:$PATH"
            set -e
            echo "Checking pixi packages..."
            command -v pixi && echo "✓ pixi"
            command -v nvim && echo "✓ neovim"
            command -v tmux && echo "✓ tmux"
            command -v starship && echo "✓ starship"
            command -v eza && echo "✓ eza"
            command -v bat && echo "✓ bat"
            command -v fzf && echo "✓ fzf"
            command -v rg && echo "✓ ripgrep"
            command -v fd && echo "✓ fd-find"
            command -v fastfetch && echo "✓ fastfetch"
          '

      - name: Verify NVM and Node
        run: |
          su - clay -c '
            export NVM_DIR="$HOME/.local/share/nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            set -e
            echo "Checking NVM..."
            command -v nvm && echo "✓ nvm"
            command -v node && echo "✓ node"
          '

      - name: Verify kitty
        run: |
          su - clay -c '
            set -e
            echo "Checking kitty..."
            [ -x ~/.local/kitty.app/bin/kitty ] && echo "✓ kitty installed"
            [ -L ~/.local/bin/kitty ] && echo "✓ kitty symlink"
          '

      - name: Verify nvim - Lazy plugins
        run: |
          su - clay -c '
            set -e
            export PATH="$HOME/.pixi/bin:$PATH"

            echo "Checking nvim location..."
            command -v nvim

            echo "Installing Lazy plugins..."
            nvim --headless "+Lazy! restore" +qa
            echo "✓ Lazy plugins installed"

            echo "Checking Lazy plugin directory..."
            PLUGIN_COUNT=$(find ~/.local/share/nvim/lazy -maxdepth 1 -type d | wc -l)
            echo "Found $PLUGIN_COUNT plugin directories"
            [ "$PLUGIN_COUNT" -gt 10 ] && echo "✓ Plugins installed successfully"
          '

      - name: Verify nvim - Treesitter parsers
        run: |
          su - clay -c '
            set -e
            export PATH="$HOME/.pixi/bin:$PATH"
            echo "Installing Treesitter parsers..."

            PARSERS="python lua rust c bash html json gitcommit gitignore"
            for parser in $PARSERS; do
              echo "Installing $parser parser..."
              nvim --headless "+TSInstallSync $parser" +qa 2>/dev/null || true
            done

            echo "Checking parser files..."
            PARSER_DIR="$HOME/.local/share/nvim/lazy/nvim-treesitter/parser"
            ls "$PARSER_DIR"/*.so 2>/dev/null | wc -l | xargs -I {} echo "Found {} parser files"
            echo "✓ Treesitter parsers installed"
          '

      - name: Verify nvim - Mason LSPs
        run: |
          su - clay -c '
            set -e
            export PATH="$HOME/.pixi/bin:$PATH"
            echo "Installing Mason packages..."

            # Install core LSPs (skip jdtls since no JDK in CI)
            MASON_PKGS="lua-language-server bash-language-server ruff shellcheck"
            for pkg in $MASON_PKGS; do
              echo "Installing $pkg..."
              nvim --headless "+MasonInstall $pkg" +qa 2>/dev/null &
            done
            wait

            # Give Mason time to finish installations
            sleep 10

            echo "Checking Mason package directory..."
            ls -la ~/.local/share/nvim/mason/packages/ 2>/dev/null || echo "Mason packages directory exists"
            echo "✓ Mason LSP installation triggered"
          '

      - name: Verify nvim - Health check
        run: |
          su - clay -c '
            set -e
            export PATH="$HOME/.pixi/bin:$PATH"
            echo "Running nvim health checks..."

            # Check that nvim starts without errors
            nvim --headless -c "qa" && echo "✓ nvim starts cleanly"

            # Run checkhealth for key components
            nvim --headless -c "checkhealth lazy" -c "qa" 2>&1 | head -20 || true
            echo "✓ Health checks completed"
          '

      - name: Summary
        run: |
          echo "Bootstrap completed successfully!"
          su - clay -c 'ls -la ~/'
