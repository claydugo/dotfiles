name: Test Bootstrap

on:
  push:
    branches: [main]
    paths:
      - 'scripts/bootstrap.sh'
      - '.config/nvim/**'
      - '.github/workflows/test-bootstrap.yml'
  pull_request:
    paths:
      - 'scripts/bootstrap.sh'
      - '.config/nvim/**'
  workflow_dispatch:

jobs:
  test-bootstrap:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ubuntu:24.04

    steps:
      - name: Install prerequisites
        run: |
          apt-get update
          apt-get install -y git curl sudo tree xz-utils fontconfig gcc

      - name: Create test user
        run: |
          useradd -m -s /bin/bash clay
          echo "clay ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

      - name: Clone dotfiles
        run: |
          su - clay -c "git clone https://github.com/claydugo/dotfiles.git ~/dotfiles"

      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          path: dotfiles-pr

      - name: Copy PR changes
        run: |
          cp -r dotfiles-pr/* /home/clay/dotfiles/ 2>/dev/null || true
          cp -r dotfiles-pr/.* /home/clay/dotfiles/ 2>/dev/null || true
          chown -R clay:clay /home/clay/dotfiles

      - name: Run bootstrap
        run: |
          su - clay -c "cd ~/dotfiles && ./scripts/bootstrap.sh"

      - name: Verify symlinks
        run: |
          su - clay -c '
            set -e
            echo "Checking symlinks..."

            test_symlink() {
              local symlink=$1
              local expected=$2
              if [ -L "$symlink" ]; then
                local target=$(readlink -f "$symlink")
                if [[ "$target" == *"$expected"* ]]; then
                  echo "✓ $symlink -> $expected"
                else
                  echo "✗ $symlink points to wrong target: $target"
                  return 1
                fi
              else
                echo "✗ $symlink is not a symlink"
                return 1
              fi
            }

            test_symlink ~/.bashrc ".bashrc"
            test_symlink ~/.gitignore ".gitignore"
            test_symlink ~/.gitlab_ci_skip ".gitlab_ci_skip"
            test_symlink ~/.claude ".claude"
            test_symlink ~/.config/nvim "nvim"
            test_symlink ~/.config/kitty "kitty"
            test_symlink ~/.config/starship.toml "starship.toml"

            if bash -n ~/.bashrc 2>/dev/null; then
              echo "✓ .bashrc syntax valid"
            else
              echo "✗ .bashrc has syntax errors"
              exit 1
            fi
          '

      - name: Verify pixi packages (functional)
        run: |
          su - clay -c '
            export PATH="$HOME/.pixi/bin:$PATH"
            set -e
            echo "Checking pixi packages functionality..."

            pixi --version && echo "✓ pixi"
            nvim --version | head -1 && echo "✓ neovim"
            tmux -V && echo "✓ tmux"
            starship --version && echo "✓ starship"
            eza --version | head -1 && echo "✓ eza"
            bat --version && echo "✓ bat"
            fzf --version && echo "✓ fzf"
            rg --version | head -1 && echo "✓ ripgrep"
            fd --version && echo "✓ fd-find"
            fastfetch --version && echo "✓ fastfetch"
            stylua --version && echo "✓ stylua"
            jj --version && echo "✓ jujutsu"
            hyperfine --version && echo "✓ hyperfine"
          '

      - name: Verify NVM and Node (functional)
        run: |
          su - clay -c '
            export NVM_DIR="$HOME/.local/share/nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            set -e
            echo "Checking NVM and Node functionality..."

            nvm --version && echo "✓ nvm"

            node_version=$(node --version)
            if [[ "$node_version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              echo "✓ node $node_version"
            else
              echo "✗ node returned invalid version: $node_version"
              exit 1
            fi

            # Test npm
            npm --version && echo "✓ npm"
          '

      - name: Verify kitty (functional)
        run: |
          su - clay -c '
            echo "Checking kitty installation..."

            if [ -x ~/.local/kitty.app/bin/kitty ]; then
              kitty_version=$(~/.local/kitty.app/bin/kitty --version 2>&1 || true)
              echo "✓ kitty binary: $kitty_version"
            else
              echo "✗ kitty binary not found or not executable"
              exit 1
            fi

            if [ -L ~/.local/bin/kitty ]; then
              echo "✓ kitty symlink exists"
            else
              echo "⚠ kitty symlink missing (non-fatal)"
            fi
          '

      - name: Verify nvim setup (functional)
        run: |
          su - clay -c '
            set -e
            export PATH="$HOME/.pixi/bin:$PATH"
            echo "Checking nvim setup and functionality..."

            nvim_version=$(nvim --version | head -1)
            echo "✓ $nvim_version"

            if [ -d ~/.local/share/nvim/lazy ]; then
              plugin_count=$(find ~/.local/share/nvim/lazy -maxdepth 1 -type d | wc -l)
              if [ "$plugin_count" -gt 10 ]; then
                echo "✓ Lazy plugins installed ($plugin_count plugins)"
              else
                echo "⚠ Fewer than expected plugins ($plugin_count)"
              fi
            else
              echo "✗ Lazy plugin directory not found"
              exit 1
            fi

            PARSER_DIR="$HOME/.local/share/nvim/lazy/nvim-treesitter/parser"
            if [ -d "$PARSER_DIR" ]; then
              parser_count=$(ls "$PARSER_DIR"/*.so 2>/dev/null | wc -l)
              if [ "$parser_count" -gt 5 ]; then
                echo "✓ Treesitter parsers ($parser_count parsers)"
              else
                echo "⚠ Fewer than expected parsers ($parser_count)"
              fi
            else
              echo "⚠ Treesitter parser directory not found"
            fi

            if [ -d ~/.local/share/nvim/mason/packages ]; then
              mason_count=$(ls -d ~/.local/share/nvim/mason/packages/* 2>/dev/null | wc -l)
              echo "✓ Mason packages ($mason_count packages)"
            else
              echo "✗ Mason directory not found"
              exit 1
            fi

            if timeout 30 nvim --headless -c "qa" 2>&1 | grep -qi error; then
              echo "✗ nvim started with errors"
              exit 1
            fi
            echo "✓ nvim starts cleanly"
          '

      - name: Test Summary
        if: always()
        run: |
          {
            echo "## Bootstrap Test Results"
            echo ""
            echo "### Verification Coverage"
            echo "- ✓ Symlinks verified (existence + target correctness)"
            echo "- ✓ .bashrc validated (syntax check)"
            echo "- ✓ Pixi packages tested (version checks)"
            echo "- ✓ NVM/Node verified (version validation)"
            echo "- ✓ Kitty binary tested"
            echo "- ✓ Neovim setup validated (plugins, parsers, Mason, startup)"
            echo ""
            echo "### Environment"
            echo "| Component | Version |"
            echo "|-----------|---------|"
          } >> "$GITHUB_STEP_SUMMARY"

          su - clay -c '
            export PATH="$HOME/.pixi/bin:$PATH"
            export NVM_DIR="$HOME/.local/share/nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            echo "| pixi | $(pixi --version 2>/dev/null || echo "N/A") |"
            echo "| nvim | $(nvim --version 2>/dev/null | head -1 || echo "N/A") |"
            echo "| node | $(node --version 2>/dev/null || echo "N/A") |"
            echo "| kitty | $(~/.local/kitty.app/bin/kitty --version 2>/dev/null || echo "N/A") |"
          ' >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Bootstrap test completed successfully ✓" >> "$GITHUB_STEP_SUMMARY"
